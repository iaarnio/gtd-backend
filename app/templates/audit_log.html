{% extends "base.html" %}

{% block title %}Audit Log{% endblock %}

{% block content %}
<h2>Audit Log</h2>
<p>Complete trail of all captures from ingestion through approval to RTM sync.</p>

<style>
    .small { font-size: 0.85rem; color: #666; }
    .badge { display: inline-block; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem; text-transform: uppercase; margin-right: 0.5rem; }
    .badge-proposed { background: #fff3cd; color: #856404; }
    .badge-approved { background: #d4edda; color: #155724; }
    .badge-rejected { background: #f8d7da; color: #721c24; }
    .badge-pending { background: #e2e3e5; color: #383d41; }
    .badge-committed { background: #d4edda; color: #155724; }
    .badge-failed { background: #f8d7da; color: #721c24; }
    .email-link { color: #0066cc; text-decoration: none; }
    .email-link:hover { text-decoration: underline; }
    table { font-size: 0.9rem; }
    tr:hover { background-color: #f9f9f9; }
</style>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Created</th>
            <th>Source</th>
            <th>Raw Text (first 60 chars)</th>
            <th>Clarified</th>
            <th>Decision</th>
            <th>RTM Status</th>
        </tr>
    </thead>
    <tbody>
    {% for capture in captures %}
        <tr>
            <td><strong>#{{ capture.id }}</strong></td>
            <td class="small">{{ capture.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="small">
                <div>{{ capture.source }}</div>
                {% if capture.email_id %}
                    <div style="color: #999; font-size: 0.8rem; margin-top: 0.2rem;">
                        {% if capture.email_link %}
                            <a href="{{ capture.email_link }}" target="_blank" class="email-link">{{ capture.email_id[:20] }}...</a>
                        {% else %}
                            {{ capture.email_id[:20] }}...
                        {% endif %}
                    </div>
                {% endif %}
            </td>
            <td><span class="small"><code>{{ capture.raw_text }}</code></span></td>
            <td><span class="small">{{ capture.clarified_text }}</span></td>
            <td>
                <span class="badge badge-{{ capture.decision_status }}">{{ capture.decision_status }}</span>
                {% if capture.decision_at %}
                    <div class="small">{{ capture.decision_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                {% endif %}
            </td>
            <td>
                <span class="badge badge-{{ capture.commit_status }}">{{ capture.commit_status }}</span>
                {% if capture.last_commit_attempt_at %}
                    <div class="small">{{ capture.last_commit_attempt_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                {% endif %}
                {% if capture.rtm_task_id %}
                    <div class="small">RTM: {{ capture.rtm_task_id }}</div>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% if not captures %}
    <p><em>No captures yet.</em></p>
{% else %}
    <p class="small" style="margin-top: 2rem; color: #666;">
        Total: {{ captures|length }} capture(s)
    </p>
{% endif %}

{% endblock %}
